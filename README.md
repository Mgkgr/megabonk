# Megabonk RL Bot

Набор скриптов для обучения и запуска RL-бота в игре Megabonk на базе Gymnasium + Stable-Baselines3. Проект умеет захватывать окно игры, формировать наблюдения (стек из 4 кадров 84×84 в оттенках серого) и отдавать управление агенту или простому автопилоту. Скрипты:

- `train.py` — запускает обучение PPO на среде `MegabonkEnv` и сохраняет модель в `megabonk_ppo_cnn`.
- `play.py` — загружает обученную модель и выполняет инференс (игра «вживую»).
- `megabonk_env.py` — Gymnasium-окружение с захватом экрана, управлением через `pydirectinput` и наградами за «выживание».
- `autopilot.py` — автопилот на шаблонах и простых эвристиках для меню/смерти/выбора персонажа и частично для движения в рантайме.

## Требования и зависимости

Минимальная среда:

- Windows (управление через `pydirectinput` и захват окна через `mss`/`window_capture`).
- Python 3.10+.
- Зависимости Python:
  - `mss`
  - `opencv-python` (`cv2`)
  - `pydirectinput`
  - `gymnasium`
  - `stable-baselines3`
  - `torch`
  - `numpy`

Пример установки (вариант):

```bash
pip install mss opencv-python pydirectinput gymnasium stable-baselines3 torch numpy
```

> Важно: требуется запущенная игра и корректный заголовок окна. По умолчанию в `train.py`/`play.py` используется `WINDOW = "Megabonk"` — подстройте при необходимости.

## Подготовка шаблонов

Автопилот и детектор экранов используют шаблоны (template matching). Подготовка:

1. Сделайте скриншот окна и сохраните рядом с `make_templates.py` файл `screen.png`.
   Требования к `screen.png`:
   - полный кадр окна игры (без обрезки), с тем же разрешением/масштабом, на котором будет идти захват;
   - без постобработки/масштабирования (PNG без сжатия артефактами);
   - интерфейс в привычном состоянии (видны кнопки, заголовки, HUD/миникарта),
     чтобы можно было вырезать шаблоны для нужных экранов.
2. Запустите генератор шаблонов:

```bash
python make_templates.py
```

3. Выделите ROI мышью, задайте имя шаблона (например `tpl_play`).
4. Файлы сохраняются в папку `templates/` (создаётся автоматически).

### Автопилотные сценарии и необходимые шаблоны

Автопилот использует набор базовых шаблонов. Ниже — рекомендуемый минимум:

- **Главное меню**: `tpl_play`
- **Выбор персонажа**: `tpl_char_select_title`, `tpl_fox_face`, `tpl_confirm`
- **Экран смерти**: `tpl_dead`, `tpl_confirm`
- **Экран разблокировок/оружия**: `tpl_unlocks_title`
- **Выбор оружия из сундука**: `tpl_katana`, `tpl_dexec`
- **Выбор фолиантов/книг**: `tpl_foliant_bottom1`, `tpl_foliant_bottom2`,
  `tpl_foliant_bottom3`, `tpl_blood_tome`
- **Рантайм (HUD/миникарта)**: `tpl_lvl`, `tpl_minimap`

Если часть шаблонов отсутствует, автопилот просто пропустит соответствующий сценарий,
но для стабильной работы рекомендуется собрать весь список.

## Примеры запуска

Обучение:

```bash
python train.py
```

Инференс (игра с обученной моделью):

```bash
python play.py
```

## Реализованные функции

- Захват изображения окна игры и преобразование в наблюдение 84×84×4 (grayscale stack).
- Экшн-пространство для движения, прыжка и слайда (`MultiDiscrete`).
- Автопилот по шаблонам для:
  - детекции экранов (меню, выбор персонажа, смерть, рантайм);
  - кликов по кнопкам/подтверждениям;
  - выбора персонажа (пример — лиса).
- Эвристический автопилот (опционально) для движения по цветовым признакам.
- PPO-обучение через Stable-Baselines3.

## Текущие ограничения

- Проект рассчитан на Windows и управление активным окном игры (без headless/серверного режима).
- Детекция смерти и экранов — эвристики + шаблоны; возможны ложные срабатывания при других скинах/UI.
- Награда в окружении в основном отражает «выживание»; прогресс по XP/HP пока не реализован (в коде есть заготовки).
- Шаблоны и регионы привязаны к конкретному разрешению/масштабу окна; при изменении интерфейса требуется переснять шаблоны.
- Параметры автопилота/детекции и заголовок окна нужно подстраивать под локальную установку игры.
